#!/usr/bin/env python3
"""
PM3 Basic Analyzer - Z√°kladn√≠ anal√Ωza nezn√°m√Ωch karet podle protokolu
Vytvo≈ô√≠ dump odemƒçen√Ωch karet do slo≈æky dump/
"""

import subprocess
import json
import os
import sys
from datetime import datetime
import argparse

class PM3BasicAnalyzer:
    def __init__(self, output_dir="dump"):
        self.output_dir = output_dir
        self.results = {}
        self.card_info = {}
        
        # Vytvo≈ôen√≠ v√Ωstupn√≠ slo≈æky
        os.makedirs(self.output_dir, exist_ok=True)
        
    def run_pm3_command(self, command, timeout=60):
        """Spust√≠ PM3 p≈ô√≠kaz a vr√°t√≠ v√Ωstup"""
        try:
            print(f"üîß Spou≈°t√≠m: pm3 -c \"{command}\"")
            result = subprocess.run(['pm3', '-c', command], 
                                  capture_output=True, text=True, timeout=timeout)
            return result.stdout, result.stderr, result.returncode
        except subprocess.TimeoutExpired:
            return "TIMEOUT", "", -1
        except FileNotFoundError:
            print("‚ùå CHYBA: PM3 nen√≠ nainstalov√°no nebo nen√≠ v PATH")
            return "PM3_NOT_FOUND", "", -1
        except Exception as e:
            return f"ERROR: {str(e)}", "", -1
    
    def check_hardware(self):
        """Kontrola PM3 hardware"""
        print("üîç Kontrola PM3 hardware...")
        
        stdout, stderr, returncode = self.run_pm3_command("hw status")
        if returncode != 0:
            print("‚ùå PM3 hardware nen√≠ p≈ôipraven")
            return False
            
        if "OK" in stdout:
            print("‚úÖ PM3 hardware je p≈ôipraven")
            return True
        else:
            print("‚ö†Ô∏è PM3 hardware mo≈æn√° nen√≠ spr√°vnƒõ p≈ôipojen")
            return False
    
    def detect_card(self):
        """Automatick√° detekce karty podle protokolu"""
        print("\nüîç Detekce karty...")
        
        # Krok 1: Automatick√° detekce
        stdout, stderr, returncode = self.run_pm3_command("auto")
        print(f"Auto detekce v√Ωsledek:\n{stdout}")
        
        if "MIFARE Classic" in stdout:
            return self.analyze_mifare_classic(stdout)
        elif "MIFARE Ultralight" in stdout:
            return self.analyze_mifare_ultralight(stdout)
        elif "DESFire" in stdout:
            return self.analyze_desfire(stdout)
        elif "EM410x" in stdout:
            return self.analyze_em410x(stdout)
        else:
            # Krok 2: Manu√°ln√≠ HF detekce
            print("üîç Zkou≈°√≠m manu√°ln√≠ HF detekci...")
            stdout_hf, _, _ = self.run_pm3_command("hf search")
            if stdout_hf and "found" in stdout_hf.lower():
                return self.analyze_hf_card(stdout_hf)
            
            # Krok 3: Manu√°ln√≠ LF detekce
            print("üîç Zkou≈°√≠m manu√°ln√≠ LF detekci...")
            stdout_lf, _, _ = self.run_pm3_command("lf search")
            if stdout_lf and "found" in stdout_lf.lower():
                return self.analyze_lf_card(stdout_lf)
            
            print("‚ùå Karta nebyla detekov√°na")
            return None
    
    def analyze_mifare_classic(self, detection_output):
        """Anal√Ωza MIFARE Classic karty podle protokolu"""
        print("üéØ MIFARE Classic detekov√°na - spou≈°t√≠m specializovanou anal√Ωzu...")
        
        self.card_info["type"] = "MIFARE Classic"
        
        # Z√°kladn√≠ informace
        print("  üìã Z√≠sk√°v√°m z√°kladn√≠ informace...")
        info_stdout, _, _ = self.run_pm3_command("hf mf info")
        
        # Extrakce UID
        uid = self.extract_uid(info_stdout)
        self.card_info["uid"] = uid
        
        # PRNG test
        print("  üé≤ Testujem PRNG...")
        prng_stdout, _, _ = self.run_pm3_command("hf mf hardnested t 1 000000000000")
        
        # Autopwn √∫tok
        print("  ‚ö° Spou≈°t√≠m autopwn √∫tok...")
        autopwn_stdout, _, _ = self.run_pm3_command("hf mf autopwn", timeout=300)
        
        # Kontrola √∫spƒõchu
        if "found" in autopwn_stdout.lower() and "key" in autopwn_stdout.lower():
            print("  ‚úÖ Kl√≠ƒçe nalezeny!")
            self.card_info["status"] = "cracked"
            
            # Dump karty
            print("  üíæ Vytv√°≈ô√≠m dump...")
            dump_stdout, _, _ = self.run_pm3_command("hf mf dump")
            
            return self.save_results("mifare_classic", {
                "info": info_stdout,
                "prng_test": prng_stdout,
                "autopwn": autopwn_stdout,
                "dump": dump_stdout
            })
        else:
            print("  ‚ùå Nepoda≈ôilo se prolomit kartu")
            self.card_info["status"] = "failed"
            return None
    
    def analyze_mifare_ultralight(self, detection_output):
        """Anal√Ωza MIFARE Ultralight karty podle protokolu"""
        print("üéØ MIFARE Ultralight detekov√°na - spou≈°t√≠m specializovanou anal√Ωzu...")
        
        self.card_info["type"] = "MIFARE Ultralight"
        
        # Z√°kladn√≠ informace
        print("  üìã Z√≠sk√°v√°m z√°kladn√≠ informace...")
        info_stdout, _, _ = self.run_pm3_command("hf mfu info")
        
        # Extrakce UID
        uid = self.extract_uid(info_stdout)
        self.card_info["uid"] = uid
        
        # Pokus o dump
        print("  üíæ Pokus o dump...")
        dump_stdout, _, _ = self.run_pm3_command("hf mfu dump")
        
        # Kontrola √∫spƒõchu dumpu - hled√°me indik√°tory √∫spƒõ≈°n√©ho ƒçten√≠
        if ("mfu dump file information" in dump_stdout.lower() or
            "reading tag memory" in dump_stdout.lower() or
            "block#" in dump_stdout.lower() or
            "version....." in dump_stdout.lower()):
            print("  ‚úÖ Dump √∫spƒõ≈°n√Ω!")
            self.card_info["status"] = "dumped"

            return self.save_results("mifare_ultralight", {
                "info": info_stdout,
                "dump": dump_stdout
            })
        else:
            print("  üîê Karta je chr√°nƒõna heslem, zkou≈°√≠m √∫toky...")

            # Password generation √∫tok
            print("  üéØ Generuji hesla na z√°kladƒõ UID...")
            pwdgen_stdout, _, _ = self.run_pm3_command("hf mfu pwdgen -r")

            # Dictionary √∫tok
            print("  üìö Dictionary √∫tok...")
            dict_stdout, _, _ = self.run_pm3_command("hf mfu dump -k FFFFFFFF")

            # Kontrola √∫spƒõchu dictionary √∫toku
            if ("mfu dump file information" in dict_stdout.lower() or
                "reading tag memory" in dict_stdout.lower() or
                "block#" in dict_stdout.lower()):
                print("  ‚úÖ Dump √∫spƒõ≈°n√Ω s dictionary √∫tokem!")
                self.card_info["status"] = "cracked"
                return self.save_results("mifare_ultralight", {
                    "info": info_stdout,
                    "pwdgen": pwdgen_stdout,
                    "dump": dict_stdout
                })
            else:
                print("  ‚ùå Nepoda≈ôilo se prolomit kartu")
                self.card_info["status"] = "failed"
                return None
    
    def analyze_desfire(self, detection_output):
        """Anal√Ωza DESFire karty"""
        print("üéØ DESFire detekov√°na - z√°kladn√≠ anal√Ωza...")
        
        self.card_info["type"] = "DESFire"
        
        info_stdout, _, _ = self.run_pm3_command("hf mfdes info")
        uid = self.extract_uid(info_stdout)
        self.card_info["uid"] = uid
        self.card_info["status"] = "partial"
        
        return self.save_results("desfire", {"info": info_stdout})
    
    def analyze_em410x(self, detection_output):
        """Anal√Ωza EM410x karty"""
        print("üéØ EM410x detekov√°na - ƒçten√≠ ID...")
        
        self.card_info["type"] = "EM410x"
        
        read_stdout, _, _ = self.run_pm3_command("lf em 410x_read")
        uid = self.extract_uid(read_stdout)
        self.card_info["uid"] = uid
        self.card_info["status"] = "dumped"
        
        return self.save_results("em410x", {"read": read_stdout})
    
    def analyze_hf_card(self, detection_output):
        """Anal√Ωza nezn√°m√© HF karty"""
        print("üéØ Nezn√°m√° HF karta - z√°kladn√≠ anal√Ωza...")
        
        info_stdout, _, _ = self.run_pm3_command("hf 14a info")
        self.card_info["type"] = "Unknown HF"
        self.card_info["status"] = "partial"
        
        return self.save_results("unknown_hf", {"info": info_stdout})
    
    def analyze_lf_card(self, detection_output):
        """Anal√Ωza nezn√°m√© LF karty"""
        print("üéØ Nezn√°m√° LF karta - z√°kladn√≠ anal√Ωza...")
        
        self.card_info["type"] = "Unknown LF"
        self.card_info["status"] = "partial"
        
        return self.save_results("unknown_lf", {"detection": detection_output})
    
    def extract_uid(self, output):
        """Extrakce UID z v√Ωstupu PM3"""
        lines = output.split('\n')
        for line in lines:
            if 'UID' in line or 'uid' in line:
                # Hled√°n√≠ hex hodnot
                parts = line.split()
                for part in parts:
                    if len(part) >= 8 and all(c in '0123456789ABCDEFabcdef' for c in part):
                        return part.upper()
        return "UNKNOWN"
    
    def save_results(self, card_type, analysis_data):
        """Ulo≈æen√≠ v√Ωsledk≈Ø podle protokolu"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        uid = self.card_info.get("uid", "UNKNOWN")
        status = self.card_info.get("status", "unknown")
        
        # N√°zev souboru podle protokolu
        base_filename = f"{card_type}_{uid}_{timestamp}_{status}"
        
        # Ulo≈æen√≠ JSON metadata
        metadata = {
            "card_info": {
                "uid": uid,
                "type": self.card_info.get("type", "Unknown"),
                "detected_at": datetime.now().isoformat(),
                "analyzer": "PM3 Basic Analyzer v1.0"
            },
            "analysis": analysis_data,
            "files": {
                "metadata_file": f"{base_filename}_metadata.json",
                "analysis_file": f"{base_filename}_analysis.txt"
            }
        }
        
        # Ulo≈æen√≠ soubor≈Ø
        metadata_path = os.path.join(self.output_dir, f"{base_filename}_metadata.json")
        analysis_path = os.path.join(self.output_dir, f"{base_filename}_analysis.txt")
        
        with open(metadata_path, 'w', encoding='utf-8') as f:
            json.dump(metadata, f, indent=2, ensure_ascii=False)
        
        with open(analysis_path, 'w', encoding='utf-8') as f:
            f.write(f"ANAL√ùZA KARTY - {self.card_info.get('type', 'Unknown')}\n")
            f.write("=" * 50 + "\n\n")
            f.write(f"Datum: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n")
            f.write(f"UID: {uid}\n")
            f.write(f"Status: {status}\n\n")
            
            for step, output in analysis_data.items():
                f.write(f"{step.upper()}:\n")
                f.write("-" * 30 + "\n")
                f.write(output)
                f.write("\n\n")
        
        print(f"üíæ V√Ωsledky ulo≈æeny:")
        print(f"  üìÑ Metadata: {metadata_path}")
        print(f"  üìÑ Anal√Ωza: {analysis_path}")
        
        return metadata_path

def main():
    parser = argparse.ArgumentParser(description='PM3 Basic Analyzer - Anal√Ωza nezn√°m√Ωch karet')
    parser.add_argument('--output-dir', default='dump', help='V√Ωstupn√≠ slo≈æka pro dump soubory')
    parser.add_argument('--no-hardware-check', action='store_true', help='P≈ôeskoƒçit kontrolu hardware')
    
    args = parser.parse_args()
    
    print("üöÄ PM3 Basic Analyzer - Anal√Ωza nezn√°m√Ωch karet")
    print("=" * 50)
    
    analyzer = PM3BasicAnalyzer(args.output_dir)
    
    # Kontrola hardware
    if not args.no_hardware_check:
        if not analyzer.check_hardware():
            print("‚ùå Ukonƒçuji kv≈Øli probl√©m≈Øm s hardware")
            sys.exit(1)
    
    # Detekce a anal√Ωza karty
    result = analyzer.detect_card()
    
    if result:
        print(f"\n‚úÖ Anal√Ωza dokonƒçena! V√Ωsledky ulo≈æeny v: {result}")
    else:
        print("\n‚ùå Anal√Ωza se nezda≈ôila")
        sys.exit(1)

if __name__ == "__main__":
    main()
